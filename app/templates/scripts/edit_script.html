{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold text-white mb-6">{{ title }}</h1>

    <div class="bg-base-200 p-6 rounded-lg shadow-lg border border-base-300">
        <form method="POST">
            <div class="mb-4">
                <label for="name" class="block text-sm font-medium text-gray-400 mb-2">Script Name</label>
                <input type="text" id="name" name="name" value="{{ script.name }}"
                       class="w-full bg-base-100 border border-base-300 rounded-md shadow-sm py-2 px-3
                              focus:outline-none focus:ring-accent focus:border-accent text-white" required>
            </div>
            <div class="mb-4">
                <label for="script_type" class="block text-sm font-medium text-gray-400 mb-2">Script Type</label>
                <select id="script_type" name="script_type"
                        class="w-full bg-base-100 border border-base-300 rounded-md shadow-sm py-2 px-3
                               focus:outline-none focus:ring-accent focus:border-accent text-white">
                    {% for type in script_types %}
                        <option value="{{ type }}" {% if script.script_type == type %}selected{% endif %}>
                            {{ type }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label for="script-prompt" class="block text-sm font-medium text-gray-400 mb-2">AI Script Generation (Optional)</label>
                <div class="flex gap-2 mb-3">
                    <textarea id="script-prompt" rows="3" placeholder="Describe what you want your script to do..." 
                              class="flex-1 bg-base-100 border border-base-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-accent focus:border-accent text-white"></textarea>
                    <button type="button" id="ai-generate-btn" class="bg-accent hover:bg-blue-600 text-white font-bold px-4 rounded-md transition duration-300">
                        <i class="fas fa-magic mr-1"></i>Generate
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label for="content" class="block text-sm font-medium text-gray-400 mb-2">Script Content</label>
                <textarea id="content" name="content" rows="15"
                          class="w-full bg-base-100 border border-base-300 rounded-md shadow-sm py-2 px-3
                                 font-mono text-sm focus:outline-none focus:ring-accent focus:border-accent text-gray-300"
                          required>{{ script.content }}</textarea>
            </div>
            <div class="flex justify-end space-x-4">
                <a href="{{ url_for('scripts.scripts_list') }}"
                   class="bg-base-300 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                    Cancel
                </a>
                <button type="submit"
                        class="bg-accent hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const aiGenerateBtn = document.getElementById('ai-generate-btn');
    const scriptPrompt = document.getElementById('script-prompt');
    const contentTextarea = document.getElementById('content');
    const scriptTypeSelect = document.getElementById('script_type');
    
    aiGenerateBtn.addEventListener('click', function() {
        const prompt = scriptPrompt.value.trim();
        const scriptType = scriptTypeSelect.value;
        const aiProviderElement = document.getElementById('ai-provider');
        const ai_provider = aiProviderElement ? aiProviderElement.value : 'gemini';
        
        if (!prompt) {
            alert('Please enter a description for the script.');
            return;
        }
        
        // Show loading state
        const originalText = aiGenerateBtn.innerHTML;
        aiGenerateBtn.disabled = true;
        aiGenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Generating...';
        
        fetch("{{ url_for('main.generate_script') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: prompt,
                script_type: scriptType,
                ai_provider: ai_provider,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error generating script: ' + data.error);
            } else {
                let script = data.script.trim();
                // Clean up markdown code blocks if present
                if (script.startsWith('```') && script.endsWith('```')) {
                    script = script.substring(script.indexOf('\n') + 1, script.lastIndexOf('```')).trim();
                }
                
                // Ask user if they want to replace or append
                const currentContent = contentTextarea.value.trim();
                if (currentContent) {
                    if (confirm('You already have content in the script area. Do you want to replace it with the AI-generated script? (Click Cancel to append instead)')) {
                        contentTextarea.value = script;
                    } else {
                        contentTextarea.value = currentContent + '\n\n# AI Generated Script\n' + script;
                    }
                } else {
                    contentTextarea.value = script;
                }
                
                // Clear the prompt after successful generation
                scriptPrompt.value = '';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred. Check the console for details.');
        })
        .finally(() => {
            // Restore button state
            aiGenerateBtn.disabled = false;
            aiGenerateBtn.innerHTML = originalText;
        });
    });
});
</script>

{% endblock %}
